# wiseuc-notice-uploadify-update
局域网即时通讯汇讯WiseUC_Client_Ent_5.1通知公告系统uploadify附件上传功能升级，使得windows客户端无需安装adobe flash player

改用兼容 HTML4 的 iframe 上传方案，替换 uploadify：
改用项目中已有的 `ajaxfileupload.js`（iframe 方式，兼容 HTML4）：
改用更简单直接的方式：用户选择文件后立即通过 iframe 上传。
修复上传逻辑：HTML4 中无法直接复制文件输入框，改为将原始文件输入框移动到临时表单中提交：
修复文件输入框的包装问题：

已修改为兼容 HTML4 的上传方案。主要改动：

## 修改内容

### 1. **移除 uploadify**
   - 移除了uploadify
   - 移除了相关的 CSS 和 JS 引用

### 2. **使用 iframe 方式上传（HTML4 兼容）**
   - 使用传统的 iframe + 表单方式实现无刷新上传
   - 兼容不支持 HTML5 的浏览器（如 IE8、IE9 等）

### 3. **上传流程**
   - 用户选择文件后，立即创建隐藏的 iframe 和表单
   - 将文件输入框移动到新表单中
   - 提交表单到 iframe
   - 通过监听 iframe 的 `load` 事件获取上传结果
   - 创建新的文件输入框用于下次选择

### 4. **功能保持**
   - 最多上传 5 个文件
   - 文件大小限制 10MB（HTML5 浏览器可检测，HTML4 由服务器验证）
   - 显示上传列表和状态
   - 标题自动填充
   - 删除功能

### 5. **兼容性**
   - 支持 HTML4 浏览器（IE8+、旧版 Chrome/Firefox 等）
   - 同时兼容 HTML5 浏览器（可获取文件大小等信息）

现在可以在不支持 HTML5 的浏览器中正常使用文件上传功能。上传地址保持不变：`/upfile.php?pid=xxx`。

检查上传逻辑和附件显示逻辑，排查上传成功但附件未保存和显示的问题：

检查创建公告时如何处理附件：

问题在于：上传时附件记录需要设置 `validity=0`，创建公告时再更新为 `validity=1` 并关联 `noticeId`。检查并修复：

修复 `upfile.php`：插入附件记录时设置 `validity=0` 和 `noticeId=0`，以便创建公告时能正确关联。
检查文件名传递和匹配逻辑，确保文件名正确保存和匹配：
检查文件名编码问题，确保上传时保存的文件名与创建公告时匹配的文件名一致：
修复文件名编码问题，确保与后端匹配：
修复文件名编码，使其与后端 `rawurldecode` 匹配：

已修复两个问题：

## 修复内容

### 1. **upfile.php - 添加 validity 和 noticeId 字段**
   - 在插入附件记录时，设置 `validity=0` 和 `noticeId=0`
   - 这样创建公告时可以通过 `validity=0` 条件找到未关联的附件记录
   - 创建公告时会将这些记录的 `noticeId` 更新为公告ID，`validity` 更新为 1

### 2. **notice.js - 修复文件名编码问题**
   - 使用 `encodeURIComponent` 编码文件名（与后端的 `rawurldecode` 匹配）
   - 修复了删除文件时的解码问题
   - 改进了上传成功判断逻辑，更准确地检测上传是否成功

### 工作流程
1. 用户选择文件 → 上传到服务器
2. 服务器保存文件并插入数据库记录（`validity=0`, `noticeId=0`）
3. 前端将文件名添加到 `notice.fileName` 数组
4. 用户点击发布 → 创建公告
5. 后端根据 `userId`、`validity=0` 和 `accessoryName` 匹配附件记录
6. 更新附件记录的 `noticeId` 为公告ID，`validity` 为 1
7. 查看公告时，通过 `noticeId` 和 `validity=1` 查询附件列表

现在附件应该可以正常保存和显示了。请测试：
1. 上传文件
2. 创建公告
3. 查看公告，确认附件显示正常

如果还有问题，请检查服务器日志文件（`app/logs/` 目录）查看详细错误信息。

日志显示 `error: 4`（UPLOAD_ERR_NO_FILE），表示没有文件被上传。原因是 HTML4 中文件输入框的值无法通过 JavaScript 复制或移动。修复：在用户选择文件后立即创建表单并提交，不移动或克隆文件输入框。

修复上传逻辑：HTML4 中文件输入框的值无法通过 JavaScript 复制，需要直接移动原始文件输入框，而不是克隆。

修复：在文件选择事件中，先清空文件输入框导致文件丢失。改为在文件选择后立即上传，不先清空。

已修复上传逻辑。主要改动：

## 修复内容

### 1. **修复文件输入框处理方式**
   - 问题：之前先清空文件输入框（`$(this).val('')`），导致文件数据丢失
   - 解决：不再清空，而是直接移动原始文件输入框到上传表单
   - 使用 `detach()` 而不是 `clone()`，保持文件数据

### 2. **立即上传机制**
   - 在文件选择事件中立即调用 `processFileAndUpload`
   - `processFileAndUpload` 立即调用 `uploadFileWithAjax`
   - 不延迟，避免文件数据丢失

### 3. **文件输入框管理**
   - 将包含文件数据的原始输入框移动到上传表单
   - 立即创建新的文件输入框用于下次选择
   - 确保每次上传都使用包含实际文件数据的输入框

### 4. **错误处理改进**
   - 更准确的响应检测
   - 更详细的错误提示

## 关键点

在 HTML4 中：
- 文件输入框的值无法通过 JavaScript 读取或复制
- 必须直接移动包含文件数据的原始输入框
- 必须在文件选择后立即处理，不能延迟

现在上传流程：
1. 用户选择文件
2. 立即创建表单和 iframe
3. 将包含文件数据的输入框移动到表单
4. 立即提交表单
5. 创建新的文件输入框用于下次选择

请重新测试上传功能，应该可以正常上传并保存到数据库了。


